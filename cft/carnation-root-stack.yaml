AWSTemplateFormatVersion: '2010-09-09'
Description: >-
   Project Carnation - Root Stack Template To Create a Step Function with DynamoDB table, SNS Topic with subscription 
   and a Lambda function.

Metadata:
  TemplateName: carnation-root-stack.yaml
  TemplateType: Root Stack template to create the other resources
  Version: 1.0.1
  Owner: Subhamay Bhattacharyya
  ProjectName: Project Carnation
  Modification History: 
    - 1.0.0  - April 17, 2023   -- Initial Version.       
    - 1.0.1  - July  20, 2023   -- Added a stack parameter for S3 code repository bucket.
                                -- Added a dead letter queue to park the failed events even after 3 retries on 3 successive days.
                                -- Cleaned up the Stack parameter description.
                                -- Fixed some typo errors.
    - 1.0.2  - Jul 22, 2023     -- Added Lambda and Step Function CloudWatch Log Group
                                -- Fixed some typo errors.
                                -- Renamed the state-machine.json to carnation-state-machine.asl.json

  Resources: 
    - One SNS Topic with KMS Encryption and Email Subscription.
    - One DynamoDB Table with KMS Encryption.
    - Two Lambda Functions
    - One Step Function
    - One SQS Queue for persisting error events and one dead letter queue to park the events for which the processing fails for more than three consecuitve times.
    - Five CloudWatch Alarms
  StepsToTest: |
    Manualy verify the Stack.
  StepsToCleanup: |
    Stack delete command

  AWS::CloudFormation::Interface:
    ParameterGroups:
    #################################### Project Name , Environment, Code Repo Bucket ##############
    - Label: 
        default: "Project, environment and code repository S3 bucket:"
      Parameters: 
        - ProjectName
        - Environment
        - CodeRepositoryS3Bucket
    #################################### KMS Key ###################################################
    - Label: 
        default: "KMS Configuration:"
      Parameters: 
        - KmsMasterKeyAlias
        - KmsMasterKeyId
    #################################### SNS with Email Subscription ###############################
    - Label: 
        default: "SNS Configuration:"
      Parameters: 
        - SNSTopicBaseName
        - SNSTopicDisplayName
        - SNSSubscriptionEmail
    #################################### SQS #######################################################
    - Label: 
        default: "SQS Configuration:"
      Parameters: 
        - SQSQueueBaseName
        - SQSDeadLetterQueueBaseName
        - DelaySeconds
        - MaximumMessageSize
        - MessageRetentionPeriod
        - ReceiveMessageWaitTimeSeconds
        - VisibilityTimeout
    #################################### DynamoDB Table ############################################
    - Label: 
        default: "DynamoDB Configuration:"
      Parameters: 
      - DynamoDBTableBaseName
      - DynamoDBTablePartitionKey
      - DynamoDBTablePartitionKeyAttributeType
      - DynamoDBTableSortKey
      - DynamoDBTableSortKeyAttributeType
    #################################### Lambda Function ###########################################
    - Label: 
        default: "Lambda Configuration:"
      Parameters: 
        - LambdaExecutionRoleBaseName
        - LambdaExecutionPolicyBaseName
        - LambdaFunctionGenDataBaseName
        - LambdaFunctionPutDataBaseName
        - LambdaFunctionTimeoutSecs
        - LambdaRuntime
        - LambdaFunctionGenDataCodeKey
        - LambdaFunctionPutDataCodeKey
        - LambdaReservedConcurrency
    #################################### State Machine #############################################
    - Label: 
        default: "State Machine"
      Parameters: 
        - StepFunctionBaseName
        - StepFunctionExecutionRoleBaseName
        - StepFunctionExecutionPolicyBaseName
    #################################### 1. Lambda Invocations CW Alarm ############################
    - Label: 
        default: "1. CloudWatch Lambda Invocations Alarm Configuration:"
      Parameters: 
        - AlarmNameLambdaInvocations
        - AlarmComparisonOperatorLambdaInvocations
        - AlarmThresholdLambdaInvocations
        - AlarmPeriodInSecondsLambdaInvocations
        - DatapointsToAlarmLambdaInvocations
        - EvaluationPeriodsForLambdaInvocations
    #################################### 2. Lambda Error CW Alarm ##################################
    - Label: 
        default: "2. CloudWatch Lambda Error Alarm Configuration:"
      Parameters: 
        - AlarmNameLambdaErrors
        - AlarmComparisonOperatorLambdaErrors
        - AlarmThresholdLambdaErrors
        - AlarmPeriodInSecondsLambdaErrors
        - DatapointsToAlarmLambdaErrors
        - EvaluationPeriodsForLambdaErrors
    #################################### 3. Lambda Throttles CW Alarm ##############################
    - Label: 
        default: "3. CloudWatch Lambda Throttles Alarm Configuration:"
      Parameters: 
        - AlarmNameLambdaThrottles
        - AlarmComparisonOperatorLambdaThrottles
        - AlarmThresholdLambdaThrottles
        - AlarmPeriodInSecondsLambdaThrottles
        - DatapointsToAlarmLambdaThrottles
        - EvaluationPeriodsForLambdaThrottles
    #################################### 4. Lambda Duration CW Alarm ###############################
    - Label: 
        default: "4. CloudWatch Lambda Duration Alarm Configuration:"
      Parameters: 
        - AlarmNameLambdaDuration
        - AlarmComparisonOperatorLambdaDuration
        - AlarmThresholdLambdaDuration
        - AlarmPeriodInSecondsLambdaDuration
        - DatapointsToAlarmLambdaDuration
        - EvaluationPeriodsForLambdaDuration
    #################################### 5. Lambda Concurrent Executions CW Alarm ##################
    - Label: 
        default: "5. CloudWatch Lambda Concurrent Executions Alarm Configuration:"
      Parameters: 
        - AlarmNameLambdaConcurrentExecutions
        - AlarmComparisonOperatorLambdaConcurrentExecutions
        - AlarmThresholdLambdaConcurrentExecutions
        - AlarmPeriodInSecondsLambdaConcurrentExecutions
        - DatapointsToAlarmLambdaConcurrentExecutions
        - EvaluationPeriodsForLambdaConcurrentExecutions
    ParameterLabels:
      ################################## Project Name and Environment ##############################
      ProjectName:
        default: "Project Name."
      Environment:
        default: "Environment (devl/test/prod)."
      CodeRepositoryS3Bucket:
        default: "Code repository S3 bucket."
      ################################## KMS Key ###################################################
      KmsMasterKeyAlias:
        default: "KMS Key alias."
      KmsMasterKeyId:
        default: "KMS Key Id."
      ################################## SNS Topic With Email Subscription #########################
      SNSTopicBaseName:
        default: "SNS topic base name."
      SNSTopicDisplayName:
        default: "SNS topic display name."
      SNSSubscriptionEmail:
        default: "Subscription email."
      ################################## SQS Queue #################################################
      SQSQueueBaseName:
        default: "Base name of the SQS queue."
      SQSDeadLetterQueueBaseName:
        default: "Base name of the dead letter queue."
      DelaySeconds:
        default: "Delay seconds."
      MaximumMessageSize:
        default: "Maximum size of the message."
      MessageRetentionPeriod: 
        default: "Message retention period."
      ReceiveMessageWaitTimeSeconds: 
        default: "Received message wait time in seconds."
      VisibilityTimeout:
        default: "Visibility timeout."
      ################################## DynamoDB Table ############################################
      DynamoDBTableBaseName: 
        default: "DynamoDB table base name."
      DynamoDBTablePartitionKey:
        default: "Partition Key."
      DynamoDBTablePartitionKeyAttributeType: 
        default: "Partition Key datatype."
      DynamoDBTableSortKey: 
        default: "Sort Key."
      DynamoDBTableSortKeyAttributeType: 
        default: "Sort Key datatype."
      ################################## Lambda Function ###########################################
      LambdaExecutionRoleBaseName:
        default: "Lambda function execution Role."
      LambdaExecutionPolicyBaseName: 
        default: "Lambda function execution Policy."
      LambdaFunctionGenDataBaseName:
        default: "Lambda function base name to generate random data."
      LambdaFunctionPutDataBaseName:
        default: "Lambda function base name to insert into a DynamoDB table."
      LambdaFunctionTimeoutSecs:
        default: "Lambda function timeout period (in seconds)."
      LambdaRuntime:
        default: "Lambda function runtime."
      LambdaFunctionGenDataCodeKey: 
        default: "Lambda code zip file to generate ramdom data."
      LambdaFunctionPutDataCodeKey: 
        default: "Lambda code zip file to insert into a DynamoDB table."
      LambdaReservedConcurrency:
        default: "Lambda Reserved Concurrency."
      #################################### State Machine ###########################################
      StepFunctionBaseName:
        default: "The base name of the state machine."
      StepFunctionExecutionRoleBaseName:
        default: "The base name of the State Machine execution Role."
      StepFunctionExecutionPolicyBaseName: 
        default: "The base name of the State Machine execution Policy."
      ################################## 1. Lambda Invocations CW Alarm ############################
      AlarmNameLambdaInvocations:
        default: "Lambda Invocations Alarm."
      AlarmComparisonOperatorLambdaInvocations: 
        default: "Lambda Invocations Alarm condition."
      AlarmThresholdLambdaInvocations: 
        default: "Lambda Invocations Alarm threshold."
      AlarmPeriodInSecondsLambdaInvocations: 
        default: "Lambda Invocations Alarm period."
      DatapointsToAlarmLambdaInvocations:  
        default: "Lambda Invocations Alarm datapoints."
      EvaluationPeriodsForLambdaInvocations:
        default: "Lambda Invocations Alarm evaluation periods."
      #################################### 2. Lambda Error CW Alarm ################################
      AlarmNameLambdaErrors:
        default: "Lambda Errors Alarm."
      AlarmComparisonOperatorLambdaErrors: 
        default: "Lambda Errors Alarm condition."
      AlarmThresholdLambdaErrors: 
        default: "Lambda Errors Alarm threshold."
      AlarmPeriodInSecondsLambdaErrors: 
        default: "Lambda Errors Alarm period."
      DatapointsToAlarmLambdaErrors:  
        default: "Lambda Errors Alarm datapoints."
      EvaluationPeriodsForLambdaErrors:
        default: "Lambda Errors Alarm evaluation periods."
      ################################## 3. Lambda Throttles CW Alarm ##############################
      AlarmNameLambdaThrottles:
        default: "Lambda Throttles Alarm."
      AlarmComparisonOperatorLambdaThrottles: 
        default: "Lambda Throttles Alarm condition."
      AlarmThresholdLambdaThrottles: 
        default: "Lambda Throttles Alarm threshold."
      AlarmPeriodInSecondsLambdaThrottles: 
        default: "Lambda Throttles Alarm period."
      DatapointsToAlarmLambdaThrottles:  
        default: "Lambda Throttles Alarm datapoints."
      EvaluationPeriodsForLambdaThrottles:
        default: "Lambda Throttles Alarm evaluation periods."
      ################################## 4. Lambda Duration CW Alarm ###############################
      AlarmNameLambdaDuration:
        default: "Lambda Duration Alarm."
      AlarmComparisonOperatorLambdaDuration: 
        default: "Lambda Duration Alarm condition."
      AlarmThresholdLambdaDuration: 
        default: "Lambda Duration Alarm threshold."
      AlarmPeriodInSecondsLambdaDuration: 
        default: "Lambda Duration Alarm period."
      DatapointsToAlarmLambdaDuration:  
        default: "Lambda Duration Alarm datapoints."
      EvaluationPeriodsForLambdaDuration:
        default: "Lambda Duration Alarm evaluation periods."
      ################################## 5. Lambda Concurrent Executions CW Alarm ##################
      AlarmNameLambdaConcurrentExecutions:
        default: "Lambda Concurrent Executions Alarm."
      AlarmComparisonOperatorLambdaConcurrentExecutions: 
        default: "Lambda Concurrent Executions Alarm condition."
      AlarmThresholdLambdaConcurrentExecutions: 
        default: "Lambda Concurrent Executions Alarm threshold."
      AlarmPeriodInSecondsLambdaConcurrentExecutions: 
        default: "Lambda Concurrent Executions Alarm period."
      DatapointsToAlarmLambdaConcurrentExecutions:  
        default: "Lambda Concurrent Executions Alarm datapoints."
      EvaluationPeriodsForLambdaConcurrentExecutions:
        default: "Lambda Concurrent Executions Alarm evaluation periods."
Parameters:
  ###################################### Project Name and Environment ##############################
  ProjectName:
    Default: carnation
    Description: ""
    Type: String
    MinLength: 5
    MaxLength: 30
    AllowedPattern: "[a-z]*"
    ConstraintDescription: "The length should be between 5 and 30, must contain only lowercase alphabets."
  Environment:
    Default: devl
    Description: ""
    Type: String
    AllowedValues: ["devl", "test", "prod"]
    ConstraintDescription: "The Environment must be devl / test or prod"
  CodeRepositoryS3Bucket:
    Default: subhamay-projects-repository-us-east-1
    Description: "S3 Bucket Storing The Lambda Code."
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: "[a-z][a-z0-9-.]*"
    ConstraintDescription: "The length should be between 3 and 63, must contain only lowercase letter,numbers,dash, dot and should start with a letter."
  ###################################### KMS Key ###################################################
  KmsMasterKeyAlias:
    Default: "SB-KMS"
    Type: String
    MinLength: 5
    MaxLength: 20
    AllowedPattern: "[a-zA-Z0-9-]*"
    ConstraintDescription: "The length of the KMS Key Alias should be beteen 5 and 20 and can only contain lowercase alphanumeric characters and dash."
  KmsMasterKeyId:
    Default: "e4c733c5-9fbe-4a90-bda1-6f0362bc9b89"
    Type: String
    MinLength: 36
    MaxLength: 36
    AllowedPattern: "[a-z0-9-]*"
    ConstraintDescription: "The length of the KMS Key Id should be 36 and must be lowercase alphabets, numbers and dash."
  ###################################### SNS Topic With Email Subscription #########################
  SNSTopicBaseName:
    Default: "sns-topic"
    Description: "The base name of the SNS topic.Region and environment will be added as suffix by the template."
    Type: String
    MinLength: 8
    MaxLength: 40
    AllowedPattern: "[a-z][a-z0-9-]*"
    ConstraintDescription: "The length should be between 8 and 40, must contain only lowercase letter, number, dash, dot and should start with a letter."
  SNSTopicDisplayName:
    Default: "Carnation CloudWatch Alarm For Lambda."
    Type: String
    MinLength: 30
    MaxLength: 200
    AllowedPattern: "[a-zA-Z0-9-. _]*"
    ConstraintDescription: "The length should be between 30 and 200, must alphanumeric character, space, dot dash or underscore."
  SNSSubscriptionEmail:
    Default: "subhamay.aws@gmail.com"
    Description: ""
    Type: String
    MinLength: 10
    MaxLength: 100
    AllowedPattern: "[a-zA-Z0-9-.@_]*"
    ConstraintDescription:  "The length should be between 10 and 100, must be a valid email id."
  ###################################### SQS Queue #################################################
  SQSQueueBaseName:
    Default: "sqs-queue"
    Description: "The base name of the SQS queue.Region and environment will be added as suffix by the template."
    Type: String
    MinLength: 8
    MaxLength: 20
    AllowedPattern: "[a-z][a-z0-9-]*"
    ConstraintDescription: "The length should be between 8 and 20, must contain only lowercase letter, number, dash, dot and should start with a letter."
  SQSDeadLetterQueueBaseName:
    Default: "dead-letter-queue"
    Description: "The base name of the dead letter queue.Region and environment will be added as suffix by the template."
    Type: String
    MinLength: 8
    MaxLength: 20
    AllowedPattern: "[a-z][a-z0-9-]*"
    ConstraintDescription: "The length should be between 8 and 20, must contain only lowercase letter, number, dash, dot and should start with a letter."
  DelaySeconds:
    Type: Number
    Description: ""
    Default: 0
    MinValue: 0
    MaxValue: 900
  MaximumMessageSize:
    Type: Number
    Description: ""
    Default: 262144
    MinValue: 1024
    MaxValue: 262144
  MessageRetentionPeriod:
    Type: Number
    Description: ""
    Default: 345600
    MinValue: 60
    MaxValue: 1209600
  ReceiveMessageWaitTimeSeconds:
    Type: Number
    Description: ""
    Default: 5
    MinValue: 0
    MaxValue: 20
  VisibilityTimeout:
    Type: Number
    Description: ""
    Default: 0
    MinValue: 0
    MaxValue: 43200  
  ###################################### DynamoDB Table ############################################
  DynamoDBTableBaseName:
    Default: random-strings
    Description: "The base name of the Dynamodb table used for storing random string.Region and environment will be added as suffix."
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: "[a-z][a-z0-9-]*"
    ConstraintDescription: "The length should be between 10 and 40, must contain only lowercase letter, number, dash and should start with a letter."
  DynamoDBTablePartitionKey:
    Default: sequenceNo
    Type: String
    MinLength: 2
    MaxLength: 30
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9\-_]*'
    ConstraintDescription: "Must begin with a letter and contain only alphanumeric characters."
  DynamoDBTablePartitionKeyAttributeType:
    Default: "N"
    Type: String
    AllowedValues: ["N", "S", "B"]
    ConstraintDescription: "The datatype should be either N (Number), S (String) or B (Binary)"
  DynamoDBTableSortKey:
    Default: generatedUnixTime
    Type: String
    MinLength: 2
    MaxLength: 30
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9\-_]*'
    ConstraintDescription: "Must begin with a letter and contain only alphanumeric characters."
  DynamoDBTableSortKeyAttributeType:
    Default: "N"
    Type: String
    AllowedValues: ["N", "S", "B"]
    ConstraintDescription: "the Datatype Should Be Either N (number), S (string) Or B (binary)"
  ###################################### Lambda Function ###########################################
  LambdaExecutionRoleBaseName:
    Default: lambda-execution-role
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: '[a-zA-Z-]*'
    ConstraintDescription: "Must be between 10 and 40 characters long and begin with a letter and can contain number or hyphen (-)."
  LambdaExecutionPolicyBaseName:
    Default: lambda-execution-policy
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: '[a-zA-Z-]*'
    ConstraintDescription: "Must be between 10 and 40 characters long and begin with a letter and can contain number or hyphen (-)."
  LambdaFunctionGenDataBaseName:
    Default: generate-data
    Description: "The base name of the generate data Lambda function.Region and environment will be added as suffix by the template."
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: '[a-zA-Z-]*'
    ConstraintDescription: "Must be between 10 and 40 characters long and begin with a letter and can contain number or hyphen (-)."
  LambdaFunctionPutDataBaseName:
    Default: insert-data
    Description: "The base name of the put date Lambda function.Region and environment will be added as suffix by the template."
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: '[a-zA-Z-]*'
    ConstraintDescription: "Must be between 10 and 40 characters long and begin with a letter and can contain number or hyphen (-)."
  LambdaFunctionTimeoutSecs:
    Default: 900
    Type: Number
    MinValue: 3
    MaxValue: 900
    ConstraintDescription: must be between 3 and 900 seconds.
  LambdaRuntime:
    Default: python3.8
    Description: "Lambda Runtime (Python 3.7, 3.8 or 3.9)"
    Type: String
    AllowedValues: [python3.7 ,python3.8, python3.9]
    ConstraintDescription: "The Lambda runtime should be either Python 3.7, 3.8 or 3.9"
  LambdaFunctionGenDataCodeKey:
    Default: 0063-carnation/code/python/carnation_gen_data.zip
    Type: String
    MinLength: 10
    MaxLength: 100
    AllowedPattern: "[a-zA-Z0-9-/_.]*"
    ConstraintDescription: "The length should be between 10 and 100, must contain only lowercase letter,numbers,dash, dot, underscore"
  LambdaFunctionPutDataCodeKey:
    Default: 0063-carnation/code/python/carnation_put_data.zip
    Type: String
    MinLength: 10
    MaxLength: 100
    AllowedPattern: "[a-zA-Z0-9-/_.]*"
    ConstraintDescription: "The length should be between 10 and 100, must contain only lowercase letter,numbers,dash, dot, underscore"
  LambdaReservedConcurrency:
    Default: 2
    Type: Number
    MinValue: 0
    MaxValue: 5
  #################################### State Machine ###########################################
  StepFunctionBaseName:
    Default: state-machine
    Description: "The base name the Step Function.Region and Environment will be added as suffix by the template."
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: '[a-zA-Z-]*'
    ConstraintDescription: "Must be between 5 and 255 characters long and begin with a letter and can contain number or hyphen (-)."
  StepFunctionExecutionRoleBaseName:
    Default: step-function-role
    Description: "The Execution Role of the State Machine."
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: '[a-zA-Z-]*'
    ConstraintDescription: "Must be between 5 and 255 characters long and begin with a letter and can contain number or hyphen (-)."
  StepFunctionExecutionPolicyBaseName:
    Default: step-function-policy
    Description: "The Execution Policy of the State Machine."
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: '[a-zA-Z-]*'
    ConstraintDescription: "Must be between 5 and 255 characters long and begin with a letter and can contain number or hyphen (-)."
  ###################################### 1. Lambda Invocations CW Alarm ############################
  AlarmNameLambdaInvocations:
    Default: lambda-invocations-alarm
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: '[a-zA-Z-]*'
    ConstraintDescription: "Must be between 10 and 50 characters long and begin with a letter and can contain lowercase letter, number or hyphen (-)."
  AlarmThresholdLambdaInvocations:
    Default: 5
    Type: Number
    MinValue: 1
    MaxValue: 99
    ConstraintDescription: must be between 70 and 99.
  AlarmPeriodInSecondsLambdaInvocations:
    Default: 60
    Type: Number
    MinValue: 10
    MaxValue: 3600
    ConstraintDescription: "Must be between 10 and 3600 seconds."
  DatapointsToAlarmLambdaInvocations: 
    Default: 1
    Type: Number
    MinValue: 1
    MaxValue: 10
    ConstraintDescription: must be between 1 and 10 seconds.
  EvaluationPeriodsForLambdaInvocations: 
    Default: 1
    Type: Number
    MinValue: 1
    MaxValue: 3
    ConstraintDescription: "Must be between 1 and 3 Hours."
  AlarmComparisonOperatorLambdaInvocations:
    Default: "GreaterThanOrEqualToThreshold"
    Type: String
    AllowedValues: [GreaterThanThreshold, GreaterThanOrEqualToThreshold, LessThanThreshold, LessThanOrEqualToThreshold]
  ###################################### 2. Lambda Error CW Alarm ##################################
  AlarmNameLambdaErrors:
    Default: lambda-errors
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: '[a-zA-Z-]*'
    ConstraintDescription: "Must be between 10 and 50 characters long and begin with a letter and can contain lowercase letter, number or hyphen (-)."
  AlarmThresholdLambdaErrors:
    Default: 2
    Type: Number
    MinValue: 1
    MaxValue: 99
    ConstraintDescription: "Must be between 1 and 99."
  AlarmPeriodInSecondsLambdaErrors:
    Default: 60
    Type: Number
    MinValue: 10
    MaxValue: 3600
    ConstraintDescription: "Must be between 10 and 3600 seconds."
  DatapointsToAlarmLambdaErrors: 
    Default: 1
    Type: Number
    MinValue: 1
    MaxValue: 10
    ConstraintDescription: "Must be between 1 and 10 seconds."
  EvaluationPeriodsForLambdaErrors: 
    Default: 1
    Type: Number
    MinValue: 1
    MaxValue: 3
    ConstraintDescription: "Must be between 1 and 3 Hours."
  AlarmComparisonOperatorLambdaErrors:
    Default: "GreaterThanOrEqualToThreshold"
    Type: String
    AllowedValues: [GreaterThanThreshold, GreaterThanOrEqualToThreshold, LessThanThreshold, LessThanOrEqualToThreshold]
  ###################################### 3. Lambda Throttles CW Alarm ##############################
  AlarmNameLambdaThrottles:
    Default: lambda-throttles
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: '[a-zA-Z-]*'
    ConstraintDescription: "Must be between 10 and 50 characters long and begin with a letter and can contain lowercase letter, number or hyphen (-)."
  AlarmThresholdLambdaThrottles:
    Default: 3
    Type: Number
    MinValue: 1
    MaxValue: 10
    ConstraintDescription: "Must be between 1 and 10."
  AlarmPeriodInSecondsLambdaThrottles:
    Default: 60
    Type: Number
    MinValue: 10
    MaxValue: 3600
    ConstraintDescription: "Must be between 10 and 3600 seconds."
  DatapointsToAlarmLambdaThrottles: 
    Default: 1
    Type: Number
    MinValue: 1
    MaxValue: 10
    ConstraintDescription: "Must be between 1 and 10 seconds."
  EvaluationPeriodsForLambdaThrottles: 
    Default: 1
    Type: Number
    MinValue: 1
    MaxValue: 3
    ConstraintDescription: "Must be between 1 and 3 Hours."
  AlarmComparisonOperatorLambdaThrottles:
    Default: "GreaterThanOrEqualToThreshold"
    Type: String
    AllowedValues: [GreaterThanThreshold, GreaterThanOrEqualToThreshold, LessThanThreshold, LessThanOrEqualToThreshold]
  ###################################### 4. Lambda Duration CW Alarm ###############################
  AlarmNameLambdaDuration:
    Default: lambda-duration
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: '[a-zA-Z-]*'
    ConstraintDescription: "Must be between 10 and 50 characters long and begin with a letter and can contain lowercase letter, number or hyphen (-)."
  AlarmThresholdLambdaDuration:
    Default: 100
    Type: Number
    MinValue: 0
    MaxValue: 900000
    ConstraintDescription: "Must be between 0 and 900000."
  AlarmPeriodInSecondsLambdaDuration:
    Default: 900
    Type: Number
    MinValue: 10
    MaxValue: 3600
    ConstraintDescription: "Must be between 10 and 3600 seconds."
  DatapointsToAlarmLambdaDuration: 
    Default: 1
    Type: Number
    MinValue: 1
    MaxValue: 10
    ConstraintDescription: "Must be between 1 and 10 seconds."
  EvaluationPeriodsForLambdaDuration: 
    Default: 1
    Type: Number
    MinValue: 1
    MaxValue: 3
    ConstraintDescription: "Must be between 1 and 3 Hours."
  AlarmComparisonOperatorLambdaDuration:
    Default: "GreaterThanOrEqualToThreshold"
    Type: String
    AllowedValues: [GreaterThanThreshold, GreaterThanOrEqualToThreshold, LessThanThreshold, LessThanOrEqualToThreshold]
  ###################################### 5. Lambda Concurrent Executions CW Alarm ##################
  AlarmNameLambdaConcurrentExecutions:
    Default: concurrent-exec
    Type: String
    MinLength: 10
    MaxLength: 40
    AllowedPattern: '[a-zA-Z-]*'
    ConstraintDescription: "Must be between 10 and 50 characters long and begin with a letter and can contain lowercase letter, number or hyphen (-)."
  AlarmThresholdLambdaConcurrentExecutions:
    Default: 3
    Type: Number
    MinValue: 0
    MaxValue: 10
    ConstraintDescription: "Must be between 0 and 10."
  AlarmPeriodInSecondsLambdaConcurrentExecutions:
    Default: 60
    Type: Number
    MinValue: 10
    MaxValue: 3600
    ConstraintDescription: "Must be between 10 and 3600 seconds."
  DatapointsToAlarmLambdaConcurrentExecutions: 
    Default: 1
    Type: Number
    MinValue: 1
    MaxValue: 10
    ConstraintDescription: "Must be between 1 and 10 seconds."
  EvaluationPeriodsForLambdaConcurrentExecutions: 
    Default: 1
    Type: Number
    MinValue: 1
    MaxValue: 3
    ConstraintDescription: "Must be between 1 and 3 Hours."
  AlarmComparisonOperatorLambdaConcurrentExecutions:
    Default: "GreaterThanOrEqualToThreshold"
    Type: String
    AllowedValues: [GreaterThanThreshold, GreaterThanOrEqualToThreshold, LessThanThreshold, LessThanOrEqualToThreshold]
Resources:
  ###################################### SNS Topic With Email Subscription #########################
  CarnationSNSTopic:
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://subhamay-projects-repository-us-east-1.s3.amazonaws.com/0063-carnation/cft/nested-stacks/sns-stack.yaml
      Parameters:  
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        TopicBaseName: !Ref SNSTopicBaseName
        TopicDisplayName: !Ref SNSTopicDisplayName 
        SubscriptionEmail: !Ref SNSSubscriptionEmail
        KmsMasterKeyAlias: !Ref KmsMasterKeyAlias
      TimeoutInMinutes: 15
  ###################################### SQS Queue #################################################
  CarnationSQSQueue:
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://subhamay-projects-repository-us-east-1.s3.amazonaws.com/0063-carnation/cft/nested-stacks/sqs-stack.yaml
      Parameters:  
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        SQSQueueBaseName: !Ref SQSQueueBaseName
        DelaySeconds: !Ref DelaySeconds 
        KmsMasterKeyAlias: !Ref KmsMasterKeyAlias
        MaximumMessageSize: !Ref MaximumMessageSize
        MessageRetentionPeriod: !Ref MessageRetentionPeriod
        ReceiveMessageWaitTimeSeconds: !Ref ReceiveMessageWaitTimeSeconds
        VisibilityTimeout: !Ref VisibilityTimeout
      TimeoutInMinutes: 15
  ###################################### Dead Letter Queue #########################################
  CarnationSQSDeadLetterQueue:
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "https://${CodeRepositoryS3Bucket}.s3.amazonaws.com/0063-carnation/cft/nested-stacks/sqs-stack.yaml"
      Parameters:  
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        SQSQueueBaseName: !Ref SQSDeadLetterQueueBaseName
        DelaySeconds: !Ref DelaySeconds 
        KmsMasterKeyAlias: !Ref KmsMasterKeyAlias
        MaximumMessageSize: !Ref MaximumMessageSize
        MessageRetentionPeriod: !Ref MessageRetentionPeriod
        ReceiveMessageWaitTimeSeconds: !Ref ReceiveMessageWaitTimeSeconds
        VisibilityTimeout: !Ref VisibilityTimeout
      TimeoutInMinutes: 15
  ###################################### DynamoDB Table ############################################
  CarnationDynamoDBTable:
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "https://${CodeRepositoryS3Bucket}.s3.amazonaws.com/0063-carnation/cft/nested-stacks/dynamodb-stack.yaml"
      Parameters:  
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        DynamoDBTableBaseName: !Ref DynamoDBTableBaseName
        DynamoDBTablePartitionKey: !Ref DynamoDBTablePartitionKey 
        DynamoDBTablePartitionKeyAttributeType: !Ref DynamoDBTablePartitionKeyAttributeType
        DynamoDBTableSortKey: !Ref DynamoDBTableSortKey
        DynamoDBTableSortKeyAttributeType: !Ref DynamoDBTableSortKeyAttributeType
        DynamoDBTableKmsMasterKeyAlias: !Ref KmsMasterKeyAlias
      TimeoutInMinutes: 15
  ###################################### Lambda And State Machine Execution Role ###################
  CarnationIAMExecutionRole:
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "https://${CodeRepositoryS3Bucket}.s3.amazonaws.com/0063-carnation/cft/nested-stacks/iam-role-stack.yaml"
      Parameters:  
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        LambdaExecutionRoleBaseName: !Ref LambdaExecutionRoleBaseName
        LambdaExecutionPolicyBaseName: !Ref LambdaExecutionPolicyBaseName
        LambdaFunctionOneBaseName: !Ref LambdaFunctionGenDataBaseName
        LambdaFunctionTwoBaseName: !Ref LambdaFunctionPutDataBaseName
        StepFunctionExecutionRoleBaseName: !Ref StepFunctionExecutionRoleBaseName
        StepFunctionExecutionPolicyBaseName: !Ref StepFunctionExecutionPolicyBaseName
        SNSTopicBaseName: !Ref SNSTopicBaseName
        DynamoDBTableBaseName: !Ref DynamoDBTableBaseName
        SQSQueueBaseName: !Ref SQSQueueBaseName
        SQSDeadLetterQueueBaseName: !Ref SQSDeadLetterQueueBaseName
        KmsMasterKeyId: !Ref KmsMasterKeyId
      TimeoutInMinutes: 15
  ###################################### Lambda Function One #######################################
  CarnationGenDataLambdaFunction:
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "https://${CodeRepositoryS3Bucket}.s3.amazonaws.com/0063-carnation/cft/nested-stacks/lambda-function-stack.yaml"
      Parameters:  
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        LambdaRuntime: !Ref LambdaRuntime
        LambdaFunctionTimeoutSecs: !Ref LambdaFunctionTimeoutSecs
        LambdaFunctionBaseName: !Ref LambdaFunctionGenDataBaseName
        LambdaFunctionDescription: "Carnation Lambda To Generate Some Random Data"
        LambdaFunctionCodeBucket: !Ref CodeRepositoryS3Bucket
        LambdaFunctionCodeKey: !Ref LambdaFunctionGenDataCodeKey
        LambdaExecutionRoleArn: !GetAtt CarnationIAMExecutionRole.Outputs.LambdaExecutionRoleArn
        LambdaReservedConcurrency: !Ref LambdaReservedConcurrency
        LambdaHandlerPath: "carnation_gen_data.handler"
        DynamoDBTableBaseName: "not-applicable"
        SQSQueueURL: !GetAtt CarnationSQSQueue.Outputs.SQSQueueURL
        SQSDeadLetterQueueURL: !GetAtt CarnationSQSDeadLetterQueue.Outputs.SQSQueueURL
        KmsMasterKeyId: !Ref KmsMasterKeyId
      TimeoutInMinutes: 15
  ###################################### Lambda Function Two #######################################
  CarnationPutDataLambdaFunction:
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "https://${CodeRepositoryS3Bucket}.s3.amazonaws.com/0063-carnation/cft/nested-stacks/lambda-function-stack.yaml"
      Parameters:  
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        LambdaRuntime: !Ref LambdaRuntime
        LambdaFunctionTimeoutSecs: !Ref LambdaFunctionTimeoutSecs
        LambdaFunctionBaseName: !Ref LambdaFunctionPutDataBaseName
        LambdaFunctionDescription: "Lambda Function To Insert Random Data Into A DynamoDB Table."
        LambdaFunctionCodeBucket: !Ref CodeRepositoryS3Bucket
        LambdaFunctionCodeKey: !Ref LambdaFunctionPutDataCodeKey
        LambdaExecutionRoleArn: !GetAtt CarnationIAMExecutionRole.Outputs.LambdaExecutionRoleArn
        LambdaReservedConcurrency: !Ref LambdaReservedConcurrency
        LambdaHandlerPath: "carnation_put_data.handler"
        DynamoDBTableBaseName: !Ref DynamoDBTableBaseName
        SQSQueueURL: !GetAtt CarnationSQSQueue.Outputs.SQSQueueURL
        SQSDeadLetterQueueURL: !GetAtt CarnationSQSDeadLetterQueue.Outputs.SQSQueueURL
        KmsMasterKeyId: !Ref KmsMasterKeyId
      TimeoutInMinutes: 15
  ###################################### State Machine #############################################
  CarnationStateMachineLogGroup:
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Type: AWS::Logs::LogGroup
    Properties: 
      KmsKeyId: !Sub 'arn:${AWS::Partition}:kms:${AWS::Region}:${AWS::AccountId}:key/${KmsMasterKeyId}'
      LogGroupName: !Sub '/aws/states/${ProjectName}-${StepFunctionBaseName}-${Environment}-${AWS::Region}'
      RetentionInDays: 14
      Tags: 
      - Key: ProjectName
        Value: !Ref ProjectName
      - Key:  Environment
        Value: !Ref Environment
  CarnationStateMachine:
    Type: AWS::StepFunctions::StateMachine
    Properties:
      StateMachineName: !Sub '${ProjectName}-${StepFunctionBaseName}-${Environment}-${AWS::Region}'
      DefinitionS3Location:
        Bucket: !Ref CodeRepositoryS3Bucket
        Key: 0063-carnation/cft/state-machine/carnation-state-machine.asl.json
      LoggingConfiguration:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt CarnationStateMachineLogGroup.Arn
        Level: ALL
        IncludeExecutionData: false
      DefinitionSubstitutions:
        GenDataLambda: !GetAtt CarnationGenDataLambdaFunction.Outputs.LambdaFunctionArn
        PutDataLambda: !GetAtt CarnationPutDataLambdaFunction.Outputs.LambdaFunctionArn
        SQSQueueURL: !GetAtt CarnationSQSQueue.Outputs.SQSQueueURL
      RoleArn: !GetAtt CarnationIAMExecutionRole.Outputs.StepFunctionExecutionRoleArn
      Tags: 
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key:  Environment
          Value: !Ref Environment
  ###################################### CloudWatch Alarms #########################################
  CarnationCloudWatchAlarms:
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "https://${CodeRepositoryS3Bucket}.s3.amazonaws.com/0063-carnation/cft/nested-stacks/cloudwatch-stack.yaml"
      Parameters:  
        ProjectName: !Ref ProjectName
        Environment: !Ref Environment
        LambdaFunctionName: !Sub '${ProjectName}-${LambdaFunctionPutDataBaseName}-${Environment}-${AWS::Region}'
        SNSTopicName: !Sub '${ProjectName}-${SNSTopicBaseName}-${Environment}-${AWS::Region}'
        AlarmNameLambdaInvocations: !Ref AlarmNameLambdaInvocations
        AlarmThresholdLambdaInvocations: !Ref AlarmThresholdLambdaInvocations
        AlarmPeriodInSecondsLambdaInvocations: !Ref AlarmPeriodInSecondsLambdaInvocations
        DatapointsToAlarmLambdaInvocations: !Ref DatapointsToAlarmLambdaInvocations
        EvaluationPeriodsForLambdaInvocations: !Ref EvaluationPeriodsForLambdaInvocations
        AlarmComparisonOperatorLambdaInvocations: !Ref AlarmComparisonOperatorLambdaInvocations
        AlarmNameLambdaErrors: !Ref AlarmNameLambdaErrors
        AlarmThresholdLambdaErrors: !Ref AlarmThresholdLambdaErrors
        AlarmPeriodInSecondsLambdaErrors: !Ref AlarmPeriodInSecondsLambdaErrors
        DatapointsToAlarmLambdaErrors: !Ref DatapointsToAlarmLambdaErrors
        EvaluationPeriodsForLambdaErrors: !Ref EvaluationPeriodsForLambdaErrors
        AlarmComparisonOperatorLambdaErrors: !Ref AlarmComparisonOperatorLambdaErrors
        AlarmNameLambdaThrottles: !Ref AlarmNameLambdaThrottles
        AlarmThresholdLambdaThrottles: !Ref AlarmThresholdLambdaThrottles
        AlarmPeriodInSecondsLambdaThrottles: !Ref AlarmPeriodInSecondsLambdaThrottles
        DatapointsToAlarmLambdaThrottles: !Ref DatapointsToAlarmLambdaThrottles
        EvaluationPeriodsForLambdaThrottles: !Ref EvaluationPeriodsForLambdaThrottles
        AlarmComparisonOperatorLambdaThrottles: !Ref AlarmComparisonOperatorLambdaThrottles
        AlarmNameLambdaDuration: !Ref AlarmNameLambdaDuration
        AlarmThresholdLambdaDuration: !Ref AlarmThresholdLambdaDuration
        AlarmPeriodInSecondsLambdaDuration: !Ref AlarmPeriodInSecondsLambdaDuration
        DatapointsToAlarmLambdaDuration: !Ref DatapointsToAlarmLambdaDuration
        EvaluationPeriodsForLambdaDuration: !Ref EvaluationPeriodsForLambdaDuration
        AlarmComparisonOperatorLambdaDuration: !Ref AlarmComparisonOperatorLambdaDuration
        AlarmNameLambdaConcurrentExecutions: !Ref AlarmNameLambdaConcurrentExecutions
        AlarmThresholdLambdaConcurrentExecutions: !Ref AlarmThresholdLambdaConcurrentExecutions
        AlarmPeriodInSecondsLambdaConcurrentExecutions: !Ref AlarmPeriodInSecondsLambdaConcurrentExecutions
        DatapointsToAlarmLambdaConcurrentExecutions: !Ref DatapointsToAlarmLambdaConcurrentExecutions
        EvaluationPeriodsForLambdaConcurrentExecutions: !Ref EvaluationPeriodsForLambdaConcurrentExecutions
        AlarmComparisonOperatorLambdaConcurrentExecutions: !Ref AlarmComparisonOperatorLambdaConcurrentExecutions
      TimeoutInMinutes: 5
Outputs:
  CarnationSNSTopicArn:
    Description: Carnation SNS Topic Arn
    Value: !GetAtt CarnationSNSTopic.Outputs.SNSTopicArn
  CarnationSNSSubscriptionArn:
    Description: Carnation SNS Topc Subscription Arn
    Value: !GetAtt CarnationSNSTopic.Outputs.SNSSubscriptionArn
  CarnationSQSURL:
    Description: Carnation SQS Queue URL
    Value: !GetAtt CarnationSQSQueue.Outputs.SQSQueueURL
  CarnationSQSArn:
    Description: Carnation SQS Queue Arn
    Value: !GetAtt CarnationSQSQueue.Outputs.SQSQueueArn
  CarnationSQSDeadLetterQueueURL:
    Description: Carnation SNS Topc Subscription Arn
    Value: !GetAtt CarnationSQSDeadLetterQueue.Outputs.SQSQueueURL
  CarnationSQSDeadLetterQueueArn:
    Description: Carnation SQS Queue Arn
    Value: !GetAtt CarnationSQSDeadLetterQueue.Outputs.SQSQueueArn
  CarnationDynamoDBTableArn: 
    Description: Carnation DynamoDB Table Arn
    Value: !GetAtt CarnationDynamoDBTable.Outputs.DynamoDBTableArn
  CarnationLambdaExecutionRoleArn:
    Description: Carnation Lambda Execution Role Arn
    Value: !GetAtt CarnationIAMExecutionRole.Outputs.LambdaExecutionRoleArn
  CarnationStepFunctionExecutionRoleArn:
    Description: Carnation State Function Execution Role Arn
    Value: !GetAtt CarnationIAMExecutionRole.Outputs.StepFunctionExecutionRoleArn
  CarnationGenDataLambdaFunctionArn: 
    Description: Carnation Generate A List of Random String Lambda Function Arn
    Value: !GetAtt CarnationGenDataLambdaFunction.Outputs.LambdaFunctionArn
  CarnationPutDataLambdaFunctionArn: 
    Description: Carnation Insert Data Into DynamoDB Table Lambda Function Arn
    Value: !GetAtt CarnationPutDataLambdaFunction.Outputs.LambdaFunctionArn
  CarnationGenDataLambdaFunctionLogGroupArn: 
    Description: Carnation Generate Data Lambda Function Log Group Arn
    Value: !GetAtt CarnationGenDataLambdaFunction.Outputs.LambdaFunctionLogGroupArn
  CarnationPutDataLambdaFunctionLogGroupArn: 
    Description: Carnation Insert Data Into DynamoDB Table Lambda Function Log Group Arn
    Value: !GetAtt CarnationPutDataLambdaFunction.Outputs.LambdaFunctionLogGroupArn
  CarnationStateMachineLogGroupArn:
    Description: Carnation State Machine Log Group Arn
    Value: !GetAtt CarnationStateMachineLogGroup.Arn
  CarnationStateMachineArn:
    Description: Carnation State Machine Arn
    Value: !GetAtt CarnationStateMachine.Arn
  CarnationLambdaInvocationsAlarmArn:
    Description: Carnation Lambda Invocations Alarm Arn 
    Value: !GetAtt CarnationCloudWatchAlarms.Outputs.CloudWatchAlarmLambdaInvocationsArn
  CarnationLambdaErrorsAlarmArn:
    Description: Carnation Lambda Errors Alarm Arn 
    Value: !GetAtt CarnationCloudWatchAlarms.Outputs.CloudWatchAlarmLambdaErrorsArn
  CarnationLambdaThrottlesAlarmArn:
    Description: Carnation Lambda Throttles Alarm Arn 
    Value: !GetAtt CarnationCloudWatchAlarms.Outputs.CloudWatchAlarmLambdaThrottlesArn
  CarnationLambdaDurationAlarmArn:
    Description: Carnation Lambda Duration Alarm Arn 
    Value: !GetAtt CarnationCloudWatchAlarms.Outputs.CloudWatchAlarmLambdaDurationArn
  CarnationLambdaConcurrentExecutionsAlarmArn:
    Description: Carnation Lambda Concurrent Executions Alarm Arn 
    Value: !GetAtt CarnationCloudWatchAlarms.Outputs.CloudWatchAlarmLambdaConurrentExecutionsArn
